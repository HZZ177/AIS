# 永策-C端钱包

## B端

### 集团配置

- 新增 是否开启车主端钱包 配置

  - 联动车场级的开关

- 新增 钱包支付ID配置 默认为空

- 新增 充值开票ID 配置 默认值为空

- 新增 充值开票地址 默认值为空

- 新增 充值开票产权证书/不动产权证号 默认值为空

- 关注初始化流程

### 车场配置

- 车场管理中增加一个钱包支付的开关

  - 联动集团配置的钱包开关

### 新增 钱包充值配置页面

- 充值说明

- 钱包首页banner

- 充值规格配置

### 菜单展示调整

- 菜单配置新增展示状态开关

- 历史数据处理，默认值打开

## C端

### 页面功能设计

- 新增钱包菜单

  - 没开通时，提示未开通，点击去开通

  - 开通后加载页面

    - banner

      - 对应显示钱包后台配置的banner

    - 钱包余额

      - 分别显示 总额，本金，赠送

    - 充值

      - 按钮点击跳转充值页面

    - 自动扣款

      - 没开启：显示 去开启
        开启未绑定：显示 去设置扣款车牌
        绑定车牌：显示车牌号，如果是多车牌，显示xxx等

    - 交易记录

      - 点击跳转

    - 电子发票

      - 点击跳转

- 充值

  - 显示本金，余额，赠送

  - 三个规格以内竖向显示 ，三个以上横向，三个一排

  - 充值说明按照后台配置的说明展示，没有的话整个充值说明不显示

  - 不选中规格的话按钮置灰

  - 关注充值后的比例，实际值和使用的适合是否按照比例组合使用本金赠金

- 自动扣款

  - 默认关闭，关闭时没有下方扣款车辆和添加按钮的显示，开启后展示

  - 车牌+车辆类型 唯一绑定，不可重复添加，重复时需弹框

  - 非认证车，关闭期间，已绑定的车牌可以被其他人添加

  - 认证车辆

    - 只能被自己绑定

    - 非认证车主添加时会提示被绑定，无法添加

  - 非认证车，A绑定了后关闭

    - B绑定了该车牌

      - A重新开启时，B也是开启的，A会弹出解绑提示，直接解绑

        - 该情况的时候做扣费测试，看扣款在哪个账号
          测试的时候找光远看下代码逻辑

  - 非认证车，A绑定了后关闭，关闭期间自己认证了该绑定的车牌

    - A认证后，开启前，B绑定了该车牌

      - A开启，此时B也是开启的，会自动删除B的绑定关系，保留A的

  - A绑定车牌，此时B没有开通钱包，但是认证了该车牌

    - B此时开通了钱包，绑定了该车牌，A的车牌应该被删除

  - 添加车辆按钮

    - 点击时，自动检测我的车辆中的车牌是否已经绑定自动扣款

      - 如果没有，弹窗提示可以绑定为自动扣款车辆，如果点击添加，直接添加，点击手动添加，跳转手动添加页面

      - 如果已经添加我的车辆为自动扣款车辆，直接跳转手动添加页面

    - 注意验证按钮防抖

- 绑定车牌页面调整

  - 输入八位数车牌，类型自动锁定新能源车

  - 输入小于八位数，不可选择新能源车

  - 删除车牌中间值，后面的车牌数字需要向前补齐

  - 处理历史数据
    a、将以前我的车辆中，车牌位数为8位，但是类型为非新能源类型的，都改为新能源类型
    b、将以前车牌位数为7位，但是选择了新能源类型的，都解绑了
    c.、认证了的不用管

- 交易记录页面

  - tab页面

    - 全部

      - 展示四种（钱包提现、钱包充值、临停支付、支付退款），可筛选类型，可按年筛选，默认展示全部，分页默认10

    - 充值记录

      - 钱包提现

        - 钱包提现后查看列表，详情等对应数据验证

      - 钱包充值（充值后查看列表，详情以及跳转数据验证）

        - 正常充值金额，边界值金额

        - 充值无赠送金额后验证

        - 充值且有赠送金额后验证

        - 多次充值相同金额后验证

        - 多次充值不同金额后验证

    - 扣款记录

      - 临停支付（支付后查看列表，详情以及跳转数据验证）

        - 无赠送金额支付

        - 有赠送金额支付

        - 混合支付场景验证

        - 支付失败不生成记录

      - 支付退款

        - 全额退款的情况

        - 部分退款的情况

    - 关注页面排序

  - 功能

    - 每笔记录可点击查看详情

      - 详情页面按需求检查字段

      - 支付详情和退款详情，点击跳转到订单详情，且定位到该笔订单的具体位置

    - 展示的金额为总额，进去之后才分开展示本金和赠送

- 电子发票页面

  - 点击钱包，电子发票进入

  - 可选择充值订单开票，只能对本金开票，一次可以选择多笔，开出来是一张

  - 可以查看已经开票的开票记录

  - 开票状态分为开票成功，开票失败，开票中，点击进入查看开票详情

  - 钱包提现后，提现时间节点之前的充值都不可再开票

  - 检查开票后的类型，地址，金额等是否和配置相同

- 支付改造

  - 支付按钮改为结算，合集只显示金额，不提供弹窗

  - 结算按钮点击后，打开弹窗，此时经过一串逻辑判断决定展示页面形式

    - 集团设置是否开启钱包

    - 用户是否启用钱包
      用户是否登录

    - 是否有欠费追缴

    - 是否订单中的所有撤场都支持钱包支付

    - 是否还有余额

    - 是否余额足够支付本次订单

    - 每种对应的展示样式根据需求来

  - 组合支付，按照顺序，从上向下先用钱包支付，后用微信/支付宝支付
    共三种情况

    - 1、单笔订单，部分钱包部分微信

    - 2、多笔订单，比如10笔，前三笔和第四笔的部分是钱包，第四笔的另一部分和后六笔是微信/支付宝

    - 3、多笔订单，10笔中刚好前三笔钱包支付完，后七笔微信/支付宝

- 已缴订单改造

  - 增加支付方式字段展示

    - 微信支付
      支付宝支付
      钱包支付
      钱包支付（自动扣款）

  - 如果支付方式为钱包支付，抵扣字段叫做钱包抵扣，涉及支付信息和订单明细

  - 钱包支付的订单，在临停订单开票中不可开票，不显示在列表中

### 注意点

- 接口测试

  - 钱包（钱包那边测）

    - 创建钱包接口

    - 充值接口

    - 冻结接口

    - 解冻接口

    - 支付接口

  - C端接口

    - 钱包充值支付接口

      - 主要关注金额不规范是否允许充值

    - 临停支付接口

      - 主要也是金额

    - 开通账户接口

      - 主要关注并发，网络波动等情况，会不会有一个用户多账户的情况

    - 支付回调

      - 伪造MQ
        1、充值支付接口
        先失败，再成功
        2、临停支付接口
        先失败再成功

    - 开票回调

      - 先失败后成功的情况

    - 数据库校验

      - `pay_order_no` varchar(128) DEFAULT NULL COMMENT '支付系统订单',
        `mer_order_no` varchar(128) DEFAULT NULL COMMENT '商户订单号',
        这两个是回调的对账唯一标识，需要关注

      - 关注各种金额，支付配置id，支付时间（回调里的时间），支付类型，支付中心订单号

    - 钱包支付不走回调，需要关注支付时间在各个系统是否一致
      包含路侧和封闭

- 幂等

  - 多个用户同时支付同比订单

  - 多种方式支付同一笔订单
    （封闭的压地感无感+微信）
    （路侧的无感+微信）

- 微信公众号，微信小程序，支付宝h5 三项需要重复测试

### 贯穿测试

- 充值

  - C端充值后，钱包内信息是否正确

  - 订单信息 详情等展示是否正确

- 支付

  - 拆分后，路侧，封闭的订单信息是否对应

  - 支付信息对应种类等是否正确

- 退款

  - 后台退款后 钱包查询

  - 退款结果不用管封闭和路侧

- 提现

  - 提现后 提现记录展示在c端

### 结算中心

- 待定

